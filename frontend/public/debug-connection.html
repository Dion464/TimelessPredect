<!DOCTYPE html>
<html>
<head>
    <title>Debug Connection</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
    <h1>Debug Connection</h1>
    <button id="connectBtn">Connect MetaMask</button>
    <button id="testBtn">Test Contract</button>
    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x4631BCAbD6dF18D94796344963cB60d44a4136b6";
        const ETH_PREDICTION_MARKET_ABI = [
            "function getActiveMarkets() public view returns (uint256[] memory)",
            "function buyShares(uint256 _marketId, bool _isYes) external payable"
        ];

        let provider, signer, contract;

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    
                    const network = await provider.getNetwork();
                    console.log('Network:', network);
                    document.getElementById('results').innerHTML += `<p>Connected to network: ${network.chainId}</p>`;
                    
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ETH_PREDICTION_MARKET_ABI, signer);
                    document.getElementById('results').innerHTML += `<p>Contract initialized</p>`;
                    
                } else {
                    document.getElementById('results').innerHTML += `<p>MetaMask not found</p>`;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('results').innerHTML += `<p>Connection error: ${error.message}</p>`;
            }
        });

        document.getElementById('testBtn').addEventListener('click', async () => {
            try {
                if (!contract) {
                    document.getElementById('results').innerHTML += `<p>Please connect MetaMask first</p>`;
                    return;
                }

                // Test getActiveMarkets
                document.getElementById('results').innerHTML += `<p>Testing getActiveMarkets...</p>`;
                const activeMarkets = await contract.getActiveMarkets();
                document.getElementById('results').innerHTML += `<p>Active markets: ${activeMarkets.map(id => id.toString()).join(', ')}</p>`;

                if (activeMarkets.length > 0) {
                    const marketId = activeMarkets[0];
                    
                    // Test buyShares
                    document.getElementById('results').innerHTML += `<p>Testing buyShares for market ${marketId.toString()}...</p>`;
                    const tx = await contract.buyShares(marketId, true, {
                        value: ethers.utils.parseEther("0.1"),
                        gasLimit: 300000
                    });
                    document.getElementById('results').innerHTML += `<p>Transaction sent: ${tx.hash}</p>`;
                    
                    const receipt = await tx.wait();
                    document.getElementById('results').innerHTML += `<p>Transaction confirmed!</p>`;
                }
            } catch (error) {
                console.error('Test error:', error);
                document.getElementById('results').innerHTML += `<p>Test error: ${error.message}</p>`;
                document.getElementById('results').innerHTML += `<p>Error code: ${error.code}</p>`;
                document.getElementById('results').innerHTML += `<p>Error details: ${JSON.stringify(error, null, 2)}</p>`;
            }
        });
    </script>
</body>
</html>
