<!DOCTYPE html>
<html>
<head>
    <title>Test Frontend Contract Connection</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
    <h1>Test Frontend Contract Connection</h1>
    <button id="connectBtn">Connect MetaMask</button>
    <button id="testBtn">Test Contract</button>
    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x07882Ae1ecB7429a84f1D53048d35c4bB2056877";
        const ETH_PREDICTION_MARKET_ABI = [
            "function getActiveMarkets() public view returns (uint256[] memory)",
            "function getMarket(uint256 _marketId) public view returns (tuple(uint256 id, string question, string description, string category, uint256 resolutionTime, uint256 createdAt, uint256 endTime, bool resolved, bool active, uint256 totalYesShares, uint256 totalNoShares, uint256 totalVolume, uint256 lastTradedPrice))",
            "function pricingAMM() external view returns (address)",
            "function buyShares(uint256 _marketId, bool _isYes) external payable",
            "function getCurrentPrice(uint256 _marketId, bool _isYes) external view returns (uint256)"
        ];
        const PRICING_AMM_ABI = [
            "function calculatePrice(uint256 marketId) public view returns (uint256 yesPrice, uint256 noPrice)",
            "function calculateSharesToGive(uint256 marketId, bool isYes, uint256 amount) public view returns (uint256)"
        ];

        let provider, signer, contracts;

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network);
                    document.getElementById('results').innerHTML += `<p>Connected to network: ${network.chainId}</p>`;
                    
                    // Initialize contracts
                    const predictionMarket = new ethers.Contract(
                        CONTRACT_ADDRESS,
                        ETH_PREDICTION_MARKET_ABI,
                        signer
                    );
                    
                    const pricingAMMAddress = await predictionMarket.pricingAMM();
                    console.log('PricingAMM address:', pricingAMMAddress);
                    
                    const pricingAMM = new ethers.Contract(
                        pricingAMMAddress,
                        PRICING_AMM_ABI,
                        signer
                    );
                    
                    contracts = { predictionMarket, pricingAMM };
                    document.getElementById('results').innerHTML += `<p>Contracts initialized successfully</p>`;
                    
                } else {
                    document.getElementById('results').innerHTML += `<p>MetaMask not found</p>`;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('results').innerHTML += `<p>Connection error: ${error.message}</p>`;
            }
        });

        document.getElementById('testBtn').addEventListener('click', async () => {
            try {
                if (!contracts) {
                    document.getElementById('results').innerHTML += `<p>Please connect MetaMask first</p>`;
                    return;
                }

                // Test 1: Get active markets
                document.getElementById('results').innerHTML += `<p>Testing getActiveMarkets...</p>`;
                const activeMarkets = await contracts.predictionMarket.getActiveMarkets();
                document.getElementById('results').innerHTML += `<p>Active markets: ${activeMarkets.map(id => id.toString()).join(', ')}</p>`;

                if (activeMarkets.length > 0) {
                    const marketId = activeMarkets[0];
                    
                    // Test 2: Get market data
                    document.getElementById('results').innerHTML += `<p>Testing getMarket for market ${marketId.toString()}...</p>`;
                    const market = await contracts.predictionMarket.getMarket(marketId);
                    document.getElementById('results').innerHTML += `<p>Market question: ${market.question}</p>`;

                    // Test 3: Get prices
                    document.getElementById('results').innerHTML += `<p>Testing getCurrentPrice...</p>`;
                    const yesPrice = await contracts.predictionMarket.getCurrentPrice(marketId, true);
                    const noPrice = await contracts.predictionMarket.getCurrentPrice(marketId, false);
                    document.getElementById('results').innerHTML += `<p>Prices: YES=${(yesPrice.toNumber() / 100).toFixed(0)}¢, NO=${(noPrice.toNumber() / 100).toFixed(0)}¢</p>`;

                    // Test 4: Try to buy shares (small amount)
                    document.getElementById('results').innerHTML += `<p>Testing buyShares with 0.01 ETH...</p>`;
                    const tx = await contracts.predictionMarket.buyShares(marketId, true, {
                        value: ethers.utils.parseEther("0.01")
                    });
                    document.getElementById('results').innerHTML += `<p>Buy transaction sent: ${tx.hash}</p>`;
                    
                    const receipt = await tx.wait();
                    document.getElementById('results').innerHTML += `<p>Transaction confirmed! Gas used: ${receipt.gasUsed.toString()}</p>`;
                }
            } catch (error) {
                console.error('Test error:', error);
                document.getElementById('results').innerHTML += `<p>Test error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
