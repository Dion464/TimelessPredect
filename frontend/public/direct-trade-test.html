<!DOCTYPE html>
<html>
<head>
    <title>Direct Trade Test</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
    <h1>Direct Trade Test</h1>
    <button id="connectBtn">Connect MetaMask</button>
    <button id="testBuyBtn">Test Buy YES Shares</button>
    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x19cEcCd6942ad38562Ee10bAfd44776ceB67e923";
        const ETH_PREDICTION_MARKET_ABI = [
            "function getActiveMarkets() public view returns (uint256[] memory)",
            "function getMarket(uint256 _marketId) public view returns (tuple(uint256 id, string question, string description, string category, uint256 resolutionTime, uint256 createdAt, uint256 endTime, bool resolved, bool active, uint256 totalYesShares, uint256 totalNoShares, uint256 totalVolume, uint256 lastTradedPrice))",
            "function pricingAMM() external view returns (address)",
            "function buyShares(uint256 _marketId, bool _isYes) external payable",
            "function getCurrentPrice(uint256 _marketId, bool _isYes) external view returns (uint256)"
        ];

        let provider, signer, contract;

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network);
                    document.getElementById('results').innerHTML += `<p>Connected to network: ${network.chainId}</p>`;
                    
                    // Initialize contract
                    contract = new ethers.Contract(
                        CONTRACT_ADDRESS,
                        ETH_PREDICTION_MARKET_ABI,
                        signer
                    );
                    
                    document.getElementById('results').innerHTML += `<p>Contract initialized successfully</p>`;
                    
                } else {
                    document.getElementById('results').innerHTML += `<p>MetaMask not found</p>`;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('results').innerHTML += `<p>Connection error: ${error.message}</p>`;
            }
        });

        document.getElementById('testBuyBtn').addEventListener('click', async () => {
            try {
                if (!contract) {
                    document.getElementById('results').innerHTML += `<p>Please connect MetaMask first</p>`;
                    return;
                }

                const marketId = 2; // Test market 2
                
                // Get initial prices
                const yesPrice = await contract.getCurrentPrice(marketId, true);
                const noPrice = await contract.getCurrentPrice(marketId, false);
                document.getElementById('results').innerHTML += `<p>Initial prices: YES=${(yesPrice.toNumber() / 100).toFixed(0)}¢, NO=${(noPrice.toNumber() / 100).toFixed(0)}¢</p>`;

                // Try different approaches
                document.getElementById('results').innerHTML += `<p>Trying to buy shares with 0.01 ETH...</p>`;
                
                // Method 1: Let MetaMask estimate gas
                try {
                    const tx1 = await contract.buyShares(marketId, true, {
                        value: ethers.utils.parseEther("0.01")
                    });
                    document.getElementById('results').innerHTML += `<p>Method 1 (auto gas): Transaction sent: ${tx1.hash}</p>`;
                    
                    const receipt1 = await tx1.wait();
                    document.getElementById('results').innerHTML += `<p>✅ Method 1 SUCCESS! Gas used: ${receipt1.gasUsed.toString()}</p>`;
                    
                    // Check new prices
                    const newYesPrice = await contract.getCurrentPrice(marketId, true);
                    const newNoPrice = await contract.getCurrentPrice(marketId, false);
                    document.getElementById('results').innerHTML += `<p>New prices: YES=${(newYesPrice.toNumber() / 100).toFixed(0)}¢, NO=${(newNoPrice.toNumber() / 100).toFixed(0)}¢</p>`;
                    
                    return; // Success, no need to try other methods
                } catch (error) {
                    document.getElementById('results').innerHTML += `<p>❌ Method 1 failed: ${error.message}</p>`;
                }
                
                // Method 2: Set explicit gas limit
                try {
                    const tx2 = await contract.buyShares(marketId, true, {
                        value: ethers.utils.parseEther("0.01"),
                        gasLimit: 500000
                    });
                    document.getElementById('results').innerHTML += `<p>Method 2 (explicit gas): Transaction sent: ${tx2.hash}</p>`;
                    
                    const receipt2 = await tx2.wait();
                    document.getElementById('results').innerHTML += `<p>✅ Method 2 SUCCESS! Gas used: ${receipt2.gasUsed.toString()}</p>`;
                    
                    return; // Success
                } catch (error) {
                    document.getElementById('results').innerHTML += `<p>❌ Method 2 failed: ${error.message}</p>`;
                }
                
                // Method 3: Try with gas price
                try {
                    const gasPrice = await provider.getGasPrice();
                    const tx3 = await contract.buyShares(marketId, true, {
                        value: ethers.utils.parseEther("0.01"),
                        gasLimit: 500000,
                        gasPrice: gasPrice
                    });
                    document.getElementById('results').innerHTML += `<p>Method 3 (with gas price): Transaction sent: ${tx3.hash}</p>`;
                    
                    const receipt3 = await tx3.wait();
                    document.getElementById('results').innerHTML += `<p>✅ Method 3 SUCCESS! Gas used: ${receipt3.gasUsed.toString()}</p>`;
                    
                } catch (error) {
                    document.getElementById('results').innerHTML += `<p>❌ Method 3 failed: ${error.message}</p>`;
                }
                
            } catch (error) {
                console.error('Test error:', error);
                document.getElementById('results').innerHTML += `<p>❌ Test error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
