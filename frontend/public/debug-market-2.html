<!DOCTYPE html>
<html>
<head>
    <title>Debug Market 2</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
</head>
<body>
    <h1>Debug Market 2 Trading</h1>
    <button id="connectBtn">Connect MetaMask</button>
    <button id="testMarket2Btn">Test Market 2 Trading</button>
    <div id="results"></div>

    <script>
        const CONTRACT_ADDRESS = "0x07882Ae1ecB7429a84f1D53048d35c4bB2056877";
        const ETH_PREDICTION_MARKET_ABI = [
            "function getActiveMarkets() public view returns (uint256[] memory)",
            "function getMarket(uint256 _marketId) public view returns (tuple(uint256 id, string question, string description, string category, uint256 resolutionTime, uint256 createdAt, uint256 endTime, bool resolved, bool active, uint256 totalYesShares, uint256 totalNoShares, uint256 totalVolume, uint256 lastTradedPrice))",
            "function pricingAMM() external view returns (address)",
            "function buyShares(uint256 _marketId, bool _isYes) external payable",
            "function getCurrentPrice(uint256 _marketId, bool _isYes) external view returns (uint256)"
        ];

        let provider, signer, contract;

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network);
                    document.getElementById('results').innerHTML += `<p>Connected to network: ${network.chainId}</p>`;
                    
                    // Initialize contract
                    contract = new ethers.Contract(
                        CONTRACT_ADDRESS,
                        ETH_PREDICTION_MARKET_ABI,
                        signer
                    );
                    
                    document.getElementById('results').innerHTML += `<p>Contract initialized successfully</p>`;
                    
                } else {
                    document.getElementById('results').innerHTML += `<p>MetaMask not found</p>`;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('results').innerHTML += `<p>Connection error: ${error.message}</p>`;
            }
        });

        document.getElementById('testMarket2Btn').addEventListener('click', async () => {
            try {
                if (!contract) {
                    document.getElementById('results').innerHTML += `<p>Please connect MetaMask first</p>`;
                    return;
                }

                const marketId = 2; // Test market 2 specifically
                
                // Test 1: Get market data
                document.getElementById('results').innerHTML += `<p>Testing Market ${marketId}...</p>`;
                const market = await contract.getMarket(marketId);
                document.getElementById('results').innerHTML += `<p>Market: ${market.question}</p>`;
                document.getElementById('results').innerHTML += `<p>Active: ${market.active}, Resolved: ${market.resolved}</p>`;

                // Test 2: Get current prices
                const yesPrice = await contract.getCurrentPrice(marketId, true);
                const noPrice = await contract.getCurrentPrice(marketId, false);
                document.getElementById('results').innerHTML += `<p>Prices: YES=${(yesPrice.toNumber() / 100).toFixed(0)}¢, NO=${(noPrice.toNumber() / 100).toFixed(0)}¢</p>`;

                // Test 3: Try to buy shares with 0.1 ETH (like in your screenshot)
                document.getElementById('results').innerHTML += `<p>Trying to buy shares with 0.1 ETH...</p>`;
                const tx = await contract.buyShares(marketId, true, {
                    value: ethers.utils.parseEther("0.1"),
                    gasLimit: 300000 // Set explicit gas limit
                });
                document.getElementById('results').innerHTML += `<p>Transaction sent: ${tx.hash}</p>`;
                
                const receipt = await tx.wait();
                document.getElementById('results').innerHTML += `<p>✅ Transaction confirmed! Gas used: ${receipt.gasUsed.toString()}</p>`;

                // Test 4: Check prices after transaction
                const newYesPrice = await contract.getCurrentPrice(marketId, true);
                const newNoPrice = await contract.getCurrentPrice(marketId, false);
                document.getElementById('results').innerHTML += `<p>New prices: YES=${(newYesPrice.toNumber() / 100).toFixed(0)}¢, NO=${(newNoPrice.toNumber() / 100).toFixed(0)}¢</p>`;
                
            } catch (error) {
                console.error('Test error:', error);
                document.getElementById('results').innerHTML += `<p>❌ Test error: ${error.message}</p>`;
                if (error.code) {
                    document.getElementById('results').innerHTML += `<p>Error code: ${error.code}</p>`;
                }
            }
        });
    </script>
</body>
</html>
