// Prisma schema matched with the functions we call in the chain  

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Trade {
  id            BigInt   @id @default(autoincrement()) @map("id")
  txHash        String   @map("tx_hash")
  logIndex      Int      @map("log_index")
  marketId      BigInt   @map("market_id")
  trader        String   @map("trader")
  isYes         Boolean  @map("is_yes")
  sharesWei     String   @map("shares_wei")
  priceBps      Int      @map("price_bps")
  costWei       String   @map("cost_wei")
  tradeType     String?  @map("trade_type")
  blockNumber   BigInt   @map("block_number")
  blockTime     DateTime @map("block_time")

  @@index([marketId, blockNumber], map: "trades_market_idx")
  @@index([trader], map: "trades_trader_idx")
  @@unique([txHash, logIndex])
  @@map("trades")
}

model Market {
  marketId          BigInt  @id @map("market_id")
  question          String? @map("question")
  description       String? @map("description")
  category          String? @map("category")
  imageUrl          String? @map("image_url")
  endTime           DateTime? @map("end_time")
  resolutionTime    DateTime? @map("resolution_time")
  resolved          Boolean @default(false) @map("resolved")
  outcome           Int?    @map("outcome")
  totalYesSharesWei String  @default("0") @map("total_yes_shares_wei")
  totalNoSharesWei  String  @default("0") @map("total_no_shares_wei")
  totalVolumeWei    String  @default("0") @map("total_volume_wei")
  creator           String?  @map("creator")
  lastYesPriceBps   Int?     @map("last_yes_price_bps")
  lastNoPriceBps    Int?     @map("last_no_price_bps")
  lastTradeBlock    BigInt?  @map("last_trade_block_number")
  lastTradeTxHash   String?  @map("last_trade_tx_hash")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("markets")
}

model Position {
  userAddress      String  @map("user_address")
  marketId         BigInt  @map("market_id")
  yesSharesWei     String  @default("0") @map("yes_shares_wei")
  noSharesWei      String  @default("0") @map("no_shares_wei")
  totalInvestedWei String  @default("0") @map("total_invested_wei")
  updatedAt        DateTime @default(now()) @map("updated_at")

  @@id([userAddress, marketId])
  @@map("positions")
}

enum OrderStatus {
  OPEN
  PARTIAL
  FILLED
  CANCELLED
}

model Order {
  id            BigInt       @id @default(autoincrement()) @map("id")
  maker         String       @map("maker")
  marketId      BigInt       @map("market_id")
  outcomeId     Int          @map("outcome_id")
  priceTicks    Int          @map("price_ticks")
  sizeWei       String       @map("size_wei")
  remainingWei  String       @map("remaining_wei")
  side          Boolean      @map("is_buy")
  status        OrderStatus  @default(OPEN) @map("status")
  signature     String       @map("signature")
  salt          String?      @map("salt")
  expiry        DateTime?    @map("expiry")
  orderHash     String?      @map("order_hash")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  fillsAsMaker  OrderFill[]  @relation("makerFills")
  fillsAsTaker  OrderFill[]  @relation("takerFills")

  @@index([marketId, outcomeId, side, priceTicks], map: "orders_match_idx")
  @@index([maker, marketId], map: "orders_user_market_idx")
  @@unique([signature], map: "orders_signature_unique")
  @@map("orders")
}

model OrderFill {
  id             BigInt    @id @default(autoincrement()) @map("id")
  makerOrderId   BigInt    @map("maker_order_id")
  takerOrderId   BigInt?   @map("taker_order_id")
  marketId       BigInt    @map("market_id")
  outcomeId      Int       @map("outcome_id")
  fillSizeWei    String    @map("fill_size_wei")
  fillPriceTicks Int       @map("fill_price_ticks")
  createdAt      DateTime  @default(now()) @map("created_at")

  makerOrder     Order     @relation("makerFills", fields: [makerOrderId], references: [id], onDelete: Cascade)
  takerOrder     Order?    @relation("takerFills", fields: [takerOrderId], references: [id], onDelete: Cascade)

  @@index([marketId, outcomeId], map: "order_fills_market_idx")
  @@map("order_fills")
}
